{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1>Edit System: {{ system.name }}</h1>

    <!-- Users List -->
    <div class="mb-3">
        <h2>Users</h2>
        {% if system.users.all %}
            <ul class="list-group">
                {% for user in system.users.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ user.username }}

                        <!-- Remove User Button -->
                        <form action="{% url 'remove_user' system_id=system.pk user_id=user.pk %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </li>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No users.</p>
        {% endif %}
    </div>

    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#inviteUserModal">Invite User</button>


    <!-- Invitation Modal -->
    <div class="modal" id="inviteUserModal">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h4 class="modal-title">Send an Invitation</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <!-- Modal body -->
      <div class="modal-body">
        <form id="inviteForm" method="post" action="{% url 'system_edit' pk=system.pk %}">
            {% csrf_token %}
          <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" class="form-control" id="username" name="username" required>
          </div>
          <button type="submit" class="btn btn-primary">Send Invitation</button>
        </form>
      </div>

    </div>
  </div>
</div>

    <!-- Edit System Form -->
    <form method="post" class="mt-3">
        {% csrf_token %}
        <div class="mb-3">
            {{ form.as_p }}
        </div>
        <button type="submit" name="edit_system" class="btn btn-success">Save changes</button>
    </form>

</div>
{% endblock %}

{% block javascript %}
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
document.getElementById('inviteUserButton').addEventListener('click', function() {
    const inviteForm = document.getElementById('inviteForm');
    if (inviteForm) {
        inviteForm.addEventListener('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            fetch("{% url 'system_edit' pk=system.pk %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken') // Use the getCookie function to get the token
                },
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    // Handle success
                    alert(data.message);
                    // Close the modal
                    $('#inviteModal').modal('hide');
                } else {
                    // Handle error
                    alert(data.message);
                }
            })
            .catch(error => {
                // Handle error
                alert('An error occurred: ' + error.toString());
            });
        });
    }
});

// Function to get a cookie by name
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>

{% endblock %}
